<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>nblock v8.0 (Full Manual Sync)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #87CEEB; color: white; touch-action: none; user-select: none; -webkit-user-select: none; }
        #blocker { position: absolute; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 20; cursor: pointer; }
        #instructions { font-size: 36px; text-align: center; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none; }
        #instructions span { font-size: 16px; color: #ccc; display: block; margin-top: 10px; }
        
        #menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 30; }
        .panel { background: #333; padding: 20px; border-radius: 10px; border: 2px solid #555; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        h1 { margin-top: 0; color: #4CAF50; text-transform: uppercase; letter-spacing: 2px; }
        
        textarea { width: 100%; height: 100px; background: #111; color: #0f0; border: 1px solid #666; font-family: monospace; font-size: 10px; margin: 10px 0; resize: none; box-sizing: border-box; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; font-size: 14px; transition: 0.2s; margin: 5px; color: white; }
        .btn-create { background: #4CAF50; width: 100%; }
        .btn-join { background: #2196F3; width: 100%; }
        .btn-single { background: #FF9800; width: 100%; margin-bottom: 15px; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); pointer-events: none; z-index: 10; display: none; }
        #crosshair::before, #crosshair::after { content: ''; position: absolute; background: rgba(255, 255, 255, 0.8); }
        #crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        #crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }
        
        #hud { position: absolute; top: 10px; right: 10px; font-size: 12px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; pointer-events: none; display: none; z-index: 15; text-align: right; }
        #debug-info { position: absolute; top: 60px; left: 10px; color: yellow; font-family: monospace; font-size: 12px; pointer-events: none; z-index: 4; }
        #network-log { position: absolute; top: 80px; left: 10px; color: lime; font-family: monospace; font-size: 10px; pointer-events: none; z-index: 4; text-align: left; opacity: 0.8; max-height: 200px; overflow: hidden; background: rgba(0,0,0,0.3); padding: 5px; width: 250px; }
        
        #inventory { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px; z-index: 15; display: none; }
        .slot { width: 40px; height: 40px; border: 2px solid #555; cursor: pointer; background-size: cover; image-rendering: pixelated; position: relative; }
        .slot.active { border-color: #fff; transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        .mobile-controls { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 14; }
        .touch-zone { pointer-events: auto; position: absolute; }
        #joystick-zone { bottom: 20px; left: 20px; width: 120px; height: 120px; }
        #joystick-bg { width: 100px; height: 100px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; position: absolute; }
        #joystick-stick { width: 40px; height: 40px; background: rgba(255,255,255,0.5); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .action-btn { position: absolute; width: 55px; height: 55px; background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; pointer-events: auto; }
        #btn-jump { bottom: 140px; right: 20px; }
        #btn-place { bottom: 80px; right: 20px; background: rgba(76, 175, 80, 0.4); }
        #btn-break { bottom: 20px; right: 20px; background: rgba(244, 67, 54, 0.4); }
        #mobile-toggle-btn { top: 10px; left: 10px; width: 40px; height: 40px; font-size: 20px; z-index: 50; background: rgba(0,0,0,0.5); border-radius: 10px; display: flex; align-items: center; justify-content: center; pointer-events: auto;}
    </style>
</head>
<body>
    <div id="debug-info">Blocks: 0</div>
    <div id="network-log">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞</div>
    <div id="mobile-toggle-btn">üéÆ</div>
    
    <div id="menu">
        <div class="panel">
            <h1>nblock v8.0</h1>
            <div id="setup-controls">
                <button class="btn-single" onclick="startSinglePlayer()">üë§ –û–¥–∏–Ω–æ—á–Ω–∞—è –∏–≥—Ä–∞</button>
                <button class="btn-create" onclick="setupManualMode(true)">üè† –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä (–•–æ—Å—Ç)</button>
                <button class="btn-join" onclick="setupManualMode(false)">üîë –í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É (–ì–æ—Å—Ç—å)</button>
            </div>
            <div id="manual-ui" style="display: none;">
                <p id="manual-desc" style="font-size: 11px; color: #ccc;"></p>
                <textarea id="sdp-io" placeholder="–°—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–¥..."></textarea>
                <div style="display: flex; flex-wrap: wrap; justify-content: center;">
                    <button id="manual-btn-main" class="btn-create" style="width: 45%; font-size: 12px;"></button>
                    <button id="manual-btn-confirm" class="btn-join" style="width: 45%; font-size: 12px; display: none;">–ü—Ä–∏–Ω—è—Ç—å –æ—Ç–≤–µ—Ç</button>
                    <button onclick="location.reload()" style="background: #555; width: 95%;">–ù–∞–∑–∞–¥</button>
                </div>
            </div>
        </div>
    </div>

    <div id="blocker"><div id="instructions">–ö–õ–ò–ö–ù–ò–¢–ï –ß–¢–û–ë–´ –ò–ì–†–ê–¢–¨<span>WASD - –•–æ–¥–∏—Ç—å, F - –ü–æ–ª–µ—Ç, 1-6 - –ë–ª–æ–∫–∏</span></div></div>
    <div id="crosshair"></div>
    <div id="hud">
        <span class="key">LKM</span> –°–ª–æ–º–∞—Ç—å | <span class="key">PKM</span> –ü–æ—Å—Ç–∞–≤–∏—Ç—å<br>
        <span class="key">F</span> –ü–æ–ª–µ—Ç | <span class="key">7</span> –ö–∞–º–µ—Ä–∞
    </div>
    <div id="inventory"></div>
    
    <div class="mobile-controls" id="mobile-ui">
        <div id="look-zone" class="touch-zone" style="top:0; right:0; width:60%; height:80%;"></div>
        <div id="joystick-zone" class="touch-zone"><div id="joystick-bg"><div id="joystick-stick"></div></div></div>
        <div id="btn-jump" class="action-btn">JUMP</div>
        <div id="btn-place" class="action-btn">PLACE</div>
        <div id="btn-break" class="action-btn">BREAK</div>
    </div>

    <script>
        // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–í–ò–ñ–ö–ê ---
        let renderer, scene, camera, controls, isGameActive = false;
        let isHost = false, isConnected = false;
        const worldData = new Map();
        const chunks = {};
        const worldActionLog = [];
        const dummy = new THREE.Object3D();
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        let selectedBlock = 'grass';
        const player = { velocity: new THREE.Vector3(), direction: new THREE.Vector3() };
        let moveFwd = false, moveBwd = false, moveLeft = false, moveRight = false, canJump = false, isFlying = false;
        let otherPlayerGroup, otherPlayerTargetPos = new THREE.Vector3(0, -100, 0), otherPlayerTargetRot = 0;

        function logNet(msg) {
            const el = document.getElementById('network-log');
            el.innerHTML = `> ${msg}<br>` + el.innerHTML.split('<br>').slice(0, 8).join('<br>');
        }

        // --- –ì–†–ê–§–ò–ö–ê –ò –ú–ò–† ---
        function initGraphics() {
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            document.body.appendChild(renderer.domElement);
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            const hemiLight = new THREE.HemisphereLight(0x87CEEB, 0x444444, 0.8);
            scene.add(hemiLight);

            // –¢–µ–∫—Å—Ç—É—Ä—ã (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
            const textures = {
                grass: createColorTexture('#5da130'),
                dirt: createColorTexture('#8b5a2b'),
                stone: createColorTexture('#7a7a7a')
            };

            for (let type in textures) {
                const mat = new THREE.MeshLambertMaterial({ map: textures[type] });
                const mesh = new THREE.InstancedMesh(geometry, mat, 20000);
                mesh.count = 0;
                scene.add(mesh);
                chunks[type] = mesh;
            }

            // –ú–æ–¥–µ–ª—å –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            otherPlayerGroup = new THREE.Group();
            const pMat = new THREE.MeshLambertMaterial({ color: 0xff4444 });
            const pBody = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.8, 0.5), pMat);
            otherPlayerGroup.add(pBody);
            scene.add(otherPlayerGroup);

            controls = new THREE.PointerLockControls(camera, document.body);
            generateWorld();
        }

        function createColorTexture(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 16; canvas.height = 16;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color; ctx.fillRect(0,0,16,16);
            ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(0,0,8,8);
            const tex = new THREE.CanvasTexture(canvas);
            tex.magFilter = THREE.NearestFilter; return tex;
        }

        function addBlock(x, y, z, type, remote = false) {
            const key = `${Math.round(x)},${Math.round(y)},${Math.round(z)}`;
            if (worldData.has(key)) return;
            const mesh = chunks[type];
            dummy.position.set(x, y, z);
            dummy.updateMatrix();
            mesh.setMatrixAt(mesh.count, dummy.matrix);
            worldData.set(key, { type, instanceId: mesh.count });
            mesh.count++;
            mesh.instanceMatrix.needsUpdate = true;
            document.getElementById('debug-info').innerText = `Blocks: ${worldData.size}`;
            
            if (!remote) {
                const action = { type: 'add', x, y, z, blockType: type };
                if (isHost) worldActionLog.push(action);
                sendData({ type: 'block_add', ...action });
            }
        }

        function generateWorld() {
            for(let x=-15; x<=15; x++) {
                for(let z=-15; z<=15; z++) {
                    addBlock(x, 0, z, 'grass', true);
                    if(Math.random() < 0.05) addBlock(x, 1, z, 'stone', true);
                }
            }
        }

        // --- –†–£–ß–ù–û–ô –°–ï–¢–ï–í–û–ô –ë–õ–û–ö (WebRTC) ---
        let pc, dataChannel;

        function setupManualMode(asHost) {
            isHost = asHost;
            document.getElementById('setup-controls').style.display = 'none';
            document.getElementById('manual-ui').style.display = 'block';
            
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

            pc.onicecandidate = (e) => {
                if (!e.candidate) {
                    document.getElementById('sdp-io').value = btoa(JSON.stringify(pc.localDescription));
                    logNet("–ö–æ–¥ –≥–æ—Ç–æ–≤! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É.");
                }
            };

            const mainBtn = document.getElementById('manual-btn-main');
            const desc = document.getElementById('manual-desc');

            if (isHost) {
                desc.innerText = "–®–ê–ì 1: –ñ–º–∏ –∫–Ω–æ–ø–∫—É –∏ –∫–∏–¥–∞–π –∫–æ–¥ –¥—Ä—É–≥—É. –®–ê–ì 2: –ñ–¥–∏ –æ—Ç–≤–µ—Ç –∏ –≤—Å—Ç–∞–≤–ª—è–π –µ–≥–æ –Ω–∏–∂–µ.";
                mainBtn.innerText = "–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ñ—Ñ–µ—Ä";
                mainBtn.onclick = async () => {
                    dataChannel = pc.createDataChannel("gameChannel");
                    setupDataEvents(dataChannel);
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    document.getElementById('manual-btn-confirm').style.display = 'inline-block';
                };
                
                document.getElementById('manual-btn-confirm').onclick = async () => {
                    const ansStr = document.getElementById('sdp-io').value;
                    const answer = JSON.parse(atob(ansStr));
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                };
            } else {
                desc.innerText = "–®–ê–ì 1: –í—Å—Ç–∞–≤—å –∫–æ–¥ –¥—Ä—É–≥–∞. –®–ê–ì 2: –ñ–º–∏ –∫–Ω–æ–ø–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å –Ω–æ–≤—ã–π –∫–æ–¥ –¥—Ä—É–≥—É.";
                mainBtn.innerText = "–°–æ–∑–¥–∞—Ç—å –æ—Ç–≤–µ—Ç";
                mainBtn.onclick = async () => {
                    const offStr = document.getElementById('sdp-io').value;
                    const offer = JSON.parse(atob(offStr));
                    await pc.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                };
                pc.ondatachannel = (e) => setupDataEvents(e.channel);
            }
        }

        function setupDataEvents(channel) {
            dataChannel = channel;
            channel.onopen = () => {
                logNet("–°–í–Ø–ó–¨ –£–°–¢–ê–ù–û–í–õ–ï–ù–ê!");
                isConnected = true;
                setTimeout(() => {
                    document.getElementById('menu').style.display = 'none';
                    isGameActive = true;
                    if (!isHost) sendData({ type: 'handshake_req' });
                }, 1000);
            };
            channel.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'handshake_req' && isHost) {
                    sendData({ type: 'handshake_ack', log: worldActionLog });
                } else if (data.type === 'handshake_ack') {
                    data.log.forEach(a => addBlock(a.x, a.y, a.z, a.blockType, true));
                } else if (data.type === 'block_add') {
                    addBlock(data.x, data.y, data.z, data.blockType, true);
                } else if (data.type === 'move') {
                    otherPlayerTargetPos.set(data.pos.x, data.pos.y, data.pos.z);
                    otherPlayerTargetRot = data.rot;
                }
            };
        }

        function sendData(data) {
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify(data));
            }
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò –¶–ò–ö–õ ---
        function startSinglePlayer() {
            document.getElementById('menu').style.display = 'none';
            isGameActive = true;
            camera.position.set(0, 5, 0);
        }

        document.addEventListener('keydown', (e) => {
            switch(e.code) {
                case 'KeyW': moveFwd = true; break;
                case 'KeyS': moveBwd = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyD': moveRight = true; break;
                case 'Space': if(canJump) { player.velocity.y = 10; canJump = false; } break;
            }
        });
        document.addEventListener('keyup', (e) => {
            switch(e.code) {
                case 'KeyW': moveFwd = false; break;
                case 'KeyS': moveBwd = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyD': moveRight = false; break;
            }
        });

        const raycaster = new THREE.Raycaster();
        document.addEventListener('mousedown', (e) => {
            if (!isGameActive || !controls.isLocked) return;
            raycaster.setFromCamera({x:0, y:0}, camera);
            const intersects = raycaster.intersectObjects(Object.values(chunks));
            if (intersects.length > 0) {
                const hit = intersects[0];
                if (e.button === 2) { // PKM
                    const pos = hit.point.add(hit.face.normal.multiplyScalar(0.5));
                    addBlock(Math.round(pos.x), Math.round(pos.y), Math.round(pos.z), selectedBlock);
                }
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            if (isGameActive) {
                const dt = 0.016;
                // –ü—Ä–æ—Å—Ç–∞—è –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
                player.velocity.y -= 25 * dt;
                camera.position.y += player.velocity.y * dt;
                
                if (camera.position.y < 1.8) {
                    camera.position.y = 1.8; player.velocity.y = 0; canJump = true;
                }

                // –î–≤–∏–∂–µ–Ω–∏–µ
                const dir = new THREE.Vector3();
                camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
                const side = new THREE.Vector3().crossVectors(camera.up, dir).normalize();

                if(moveFwd) camera.position.addScaledVector(dir, 0.1);
                if(moveBwd) camera.position.addScaledVector(dir, -0.1);
                if(moveLeft) camera.position.addScaledVector(side, 0.1);
                if(moveRight) camera.position.addScaledVector(side, -0.1);

                if (isConnected) {
                    const euler = new THREE.Euler().setFromQuaternion(camera.quaternion, 'YXZ');
                    sendData({ type: 'move', pos: camera.position, rot: euler.y });
                }
            }
            otherPlayerGroup.position.lerp(otherPlayerTargetPos, 0.1);
            otherPlayerGroup.rotation.y = otherPlayerTargetRot;
            renderer.render(scene, camera);
        }

        window.onload = () => {
            initGraphics();
            animate();
            document.body.addEventListener('click', () => { if(isGameActive) controls.lock(); });
        };
    </script>
</body>
</html>
